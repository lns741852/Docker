## Compose 用途

- 可以一次啟動多個容器

## 建立 Compose 配置檔

1. 創建目錄及 yml 檔

   ```
   project
    |_ backend
    |    |_ target
    |    |    |_ backend-app.jar
    |    |_ Dockerfile
    |_ docker-compose.yml
    |_ .env  # 配置docker-compose可讀變數
   ```

2. 配置 yml & .env 內容

   - yml

   ```
    services:
      backend:
        build:
            context: /backend
            dockerfile: Dockerfile
        depends_on:
            db:
                condition: service_started
        volumes:
            - "./backend-app-logs:/app/log"
        db:
            image: ${MYSQL_IMAGE}
            container_name: DemoMySQL
            ports:
                - 3306:3306
            environment:
                - MYSQL_ROOT_PASSWORD=000000
                - MYSQL_USER=user
                - MYSQL_PASSWORD=123456
                - MYSQL_DATABASE=demo
        mongo:
            # ...
        redis:
            # ...
   ```

   - .env

   ```
   MYSQL_IMAGE=mysql:8.2.0
   ```

   - 參數說明

     | Compose    | Do              | Remark |
     | ---------- | --------------- | ------ |
     | context    | Dockerfile 路徑 |        |
     | dockerfile | Dockerfile 名稱 |        |
     | depends_on | 依賴的服務      |        |
     | volumes    | 掛載            |        |

3. compose 指令

   | Docker                               | Do       | Remark                                                   |
   | ------------------------------------ | -------- | -------------------------------------------------------- |
   | docker compose -f {配置檔名稱} up -d | 啟動     | 如檔案名稱為 docker-compose.yml 可以省略 -f，-d 背景執行 |
   | docker compose stop db               | 停止     |                                                          |
   | docker compose down db               | 移除     |                                                          |
   | docker compose start db              | 重新啟動 |                                                          |
   | docker compose logs                  | 查看 log |                                                          |

4. 連線問題

   - Window and Mac 容器連線不再使用 127.0.0.1，改用　 host.docker.internal

     ```
     spring.datasource.url=jdbc:mysql://host.docker.internal:3306/your-db-name
     ```

   - Linux 加上 extra_hosts
     ```
     services:
        backend:
            # ...
            extra_hosts:
                - "host.docker.internal:host-gateway"
     ```
